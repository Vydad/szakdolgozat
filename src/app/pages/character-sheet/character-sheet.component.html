<app-navbar></app-navbar>
<div class="character-sheet" *ngIf="character$ | async as character">
  <div id="roll">
      Dob√°s:
      <br>
      {{rollShow()}}
    </div>
  <div>
  <div class="header-container">

  <div class="name">
    <h1>{{ character.appearance?.name || 'N√©vtelen' }}</h1>
    <p>
      {{ raceName || 'Ismeretlen faj' }}
      {{ className || 'Ismeretlen oszt√°ly' }}
      ‚Äì Szint {{ character.lvl }}
    </p>
  </div>

  <div class="actions">
    
    <button (click)="reset()">Hossz√∫ Pihen≈ë</button>
    <button id="lvl_up" (click)="openLevelUpPopup()">Szint l√©p√©s</button>
  </div>
<div class="popup-backdrop" *ngIf="levelUpVisible">
  <div class="popup-window">

    <button class="close-btn" (click)="closeLevelUpPopup()">‚úñ</button>

    <div class="popup-header_lvl_up">
      <div class="left-info">
        <h2>{{ character.appearance?.name || 'N√©vtelen' }}</h2>
        <p>{{ className }}</p>
      </div>
      <div class="right-info">
        <label for="levelInput">Szint: </label>
        <input 
          id="levelInput" 
          type="number" 
          [(ngModel)]="targetLevel"
          [min]="1" 
          [max]="20" 
          (change)="updateAvailableTraits()"
        />
      </div>
    </div>

    <div class="popup-content">
      <h3>√öj k√©pess√©gek</h3>
      <ul *ngIf="filteredTraits.length > 0 && filteredTraits!==undefined; else noTraits">
        <li *ngFor="let trait of filteredTraits">
          <strong>{{ trait.title }}</strong> ‚Äî Szint: {{ trait.lvl }}
          <p>{{ trait.description }}</p>
        </li>
      </ul>
      <ng-template #noTraits>
        <p>Nincs √∫j trait a megadott szinten.</p>
      </ng-template>
    </div>

    <div class="popup-footer">
      <button class="save-btn" (click)="saveLevelUp()">Ment√©s</button>
    </div>
  </div>
</div>

</div>
<div class="header">
  <div class="armory">
    <div id="speed" class="armory-contaner">
      Sebess√©g:
      <br>
      {{raceData.speed}}m
    </div>
    <div id="kezdemenyezes" class="armory-contaner">
      Kezdem√©nyez√©s:
      <br>
      <button class="skill-value-btn" id="initiative" (click)="roll(getInitiative())">
      {{getInitiative()==0? getInitiative(): getInitiative()>0? "+"+getInitiative():getInitiative()}}
      </button>
    </div>
    <div id="inspir√°cio" class="armory-contaner">
      Inspir√°ci√≥:
      <br>
      <input type="checkbox" [(ngModel)]="isCheckedInspiration" (change)="saveCheckbox()" class="armory-contaner" />
    </div>
    <div id="proficiency" class="armory-contaner">
      J√°rtass√°gi b√≥nusz:
      <br>
      {{proficiencyBonus()}}
    </div>
    <div id="armor" class="armory-contaner">
      P√°nc√©l:
      <br>
      {{ac}}
    </div>
  </div>
  
  <div class="hp">
  <p>
    <strong>√âleter≈ë:</strong> {{ character.hp }}/{{ maxHp }} <br>
    <strong>Ideiglenes √©leter≈ë:</strong>
    <input 
      type="number" 
      [(ngModel)]="temp"
      (ngModelChange)="updateTempHp()"
      min="0"
    />
  </p>

  <div class="hp-controls">
    <input type="number" [(ngModel)]="hpDelta" min="1" />
    
    <!-- Sebz√©s -->
    <button (click)="applyDamageOrHeal(character, -hpDelta)" id="sebzes">Sebz√©s</button>
    
    <!-- Gy√≥gy√≠t√°s -->
    <button (click)="applyDamageOrHeal(character, hpDelta)" [disabled]="character.hp >= maxHp" id="gyogyitas">Gy√≥gy√≠t√°s</button>
  </div>
</div>
</div>
</div>
<div class="body">
  <div class="stat">
  <h2>Adotts√°gok</h2>
  <div class="stats-container">
    <div *ngFor="let ability of character.abilities" class="stats">
      <div>
        <strong>{{ ability.name }}</strong> <br>
        {{ ability.total}} <br>
        <h3>
          {{
            ability.modifier == 0
              ? ability.modifier
              : ability.modifier > 0
              ? "+" + ability.modifier
              :  + ability.modifier
          }}
        </h3>
      </div>
        <div class="skills-list">
          <ng-container *ngFor="let skill of skills">
            <div *ngIf="skill.type === ability.name" class="skill-row">
              <span class="skill-name">{{ skill.name }}</span>
              <button (click)="roll(skill.value+ability.modifier)"
                class="skill-value-btn" 
                [ngClass]="{
                  'positive': (skill.value+ability.modifier) > 0,
                  'negative': (skill.value+ability.modifier) < 0
                }">
                {{ skill.value+ability.modifier }}
                
              </button>
            </div>
          </ng-container>
        </div>
    </div>
  </div>
</div>
<div class="main_body">
  <div class="main_body_left">
    <div class="main_body_left_top">
      <p>
        <strong>P√°nc√©lok</strong><br>
        {{character.armor}}
      </p>
      <hr>
      <p>
        <strong>Fegyverek</strong><br>
        {{character.weapon}}
      </p>
      <hr>
      <p>
        <strong>Eszk√∂z√∂k</strong><br>
        {{character.tools}}
      </p>
      <hr>
      <p>
        <strong>Nyelvek</strong><br>
        {{character.language}}
      </p>
    </div>
    <div class="main_body_left_mid">
      <h4>Ment≈ë Dob√°sok:</h4>
      <table>
        <tr>
          <td>
            Er≈ë<br>
            {{save("Er≈ë")}}
          </td>
          <td>
            √úgyess√©g<br>
            {{save("√úgyess√©g")}}
          </td>
          <td>
            √Åll√≥k√©pess√©g<br>
            {{save("√Åll√≥k√©pess√©g")}}
          </td>
        </tr>
        <tr>
          <td>
            B√∂lcsess√©g<br>
            {{save("B√∂lcsess√©g")}}
          </td>
          <td>
            Intelligencia<br>
            {{save("Intelligencia")}}
          </td>
          <td>
            Karizma<br>
            {{save("Karizma")}}
          </td>
        </tr>
      </table>
    </div>
    <div class="main_body_left_bot">
      <table>
        <tr>
          <td>
            Passz√≠v √âszlel√©s
          </td>  
          <td class="number">
            {{passziv("B√∂lcsess√©g","√âszlel√©s")}}
          </td>        
        </tr>
        <tr>
          <td>
            Passz√≠v Kutat√°s
          </td>   
          <td class="number">
            {{passziv("Intelligencia","Kutat√°s")}}
          </td>
                 
        </tr>
        <tr>
          <td>
            Passz√≠v Emberismeret
          </td>  
          <td class="number">
            {{passziv("B√∂lcsess√©g","Emberismeret")}}
          </td>
                  
        </tr>
      </table>
    </div>
  </div>
    <div class="main_body_right">
      <div class="character-navbar">
      <button 
        *ngFor="let tab of tabs" 
        (click)="selectTab(tab)"
        [class.active]="selectedTab === tab">
        {{ tab }}
      </button>
      <button 
      *ngIf="character.mage==true"
      (click)="selectTab('Var√°zslatok')"
      [class.active]="selectedTab === 'Var√°zslatok'">
      Var√°zslatok
    </button>
    </div>
    <div class="character-content">
      <ng-container [ngSwitch]="selectedTab">

        <!-- ACTION -->
        <div *ngSwitchCase="'Akci√≥k'" class="tab-content">
          <div class="action">
            <h2>Akci√≥k</h2>
            <div class="equipment" *ngIf="characterData?.equipment?.length && equippedWeapons.length; else noAction">
              <table class="equipment-table">
                <thead>
                  <tr>
                  <th>N√©v</th>
                  <th>T√°vols√°g</th>
                  <th>Tal√°lat</th>
                  <th>Sebz√©s</th>
                </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let item of equipmentWeapon" (mouseenter)="startTooltipTimer($event, item)" (mouseleave)="hideTooltip()" (mousemove)="moveTooltip($event)">
                    <td>{{ item.name }}</td>
                    <td>{{ item.range+"m"}}</td>
                    <td>
                      <button class="skill-value-btn" id="weapon_hit"(click)="roll(attackRoll(item.mod,item.type))">
                        {{attackRoll(item.mod,item.type)>0? '+' + attackRoll(item.mod,item.type):attackRoll(item.mod,item.type)}}
                      </button>
                    </td>
                    <td>
                      <ng-container *ngIf="item.dmg">
                        <button class="skill-value-btn" id="weapon_dmg"
                          *ngFor="let dmgPart of item.dmg.split(',')" 
                          (click)="rollDamage(item.mod,dmgPart.trim())">
                          {{ dmgPart.trim()+dmgMod(item.mod)}}
                        </button>
                      </ng-container>
                    </td>
                  </tr>
                </tbody>
              </table>
              <!-- Tooltip -->
              <div
                class="item-tooltip"
                *ngIf="tooltipVisible"
                [ngStyle]="{ top: tooltipY + 'px', left: tooltipX + 'px' }"
              >
                <h4>{{ tooltipItem?.name }}</h4>
                <p>{{ tooltipItem?.description }}</p>
              </div>
            </div>
            <ng-template #noAction>
              <p>Nincs felszerelve fegyver.</p>
            </ng-template>
            <div *ngFor="let trait of characterData?.traits">
              <div *ngIf="trait.action && trait.action_type=='a'">
                <h4>{{ trait.name }}</h4>
                <p>{{ trait.action_des }}</p>

                <!-- Charge boxok -->
                <div class="charge-boxes">
                  <ng-container *ngFor="let c of getChargeArray(trait); let i = index">
                    <input
                      type="checkbox"
                      [checked]="i < (trait.charge - trait.temp_charge)"
                      (change)="toggleCharge(trait, i)"
                    />
                  </ng-container>
                </div>
              </div>
            </div>
          </div>
          <div class="bonus_action">
            <hr>
            <h3>Bonusz Akci√≥k</h3>
            <div *ngFor="let trait of characterData?.traits">
              <div *ngIf="trait.action && trait.action_type=='ba'">
                <h4>{{ trait.name }}</h4>
                <span>{{trait.dmg}}</span>
                <p>{{ trait.action_des }}</p>

                <!-- Charge boxok -->
                <div class="charge-boxes">
                  <div
                    *ngFor="let c of getChargeArray(trait); let i = index"
                    class="charge-slot"
                    [class.filled]="i < (trait.charge - trait.temp_charge)"
                    (click)="toggleCharge(trait, i)"
                  ></div>
                </div>
              </div>
            </div>
          </div>
          <div class="bonus_action">
            <hr>
            <h3>Reakci√≥k</h3>
            <div>
              <h4>H√°tbat√°mad√°s</h4>
              <p>Akkor haszn√°lhatsz h√°tba t√°mad√°st amikor egy l√©ny amit l√°tsz kil√©p a kar t√°vols√°godb√≥l elhaszn√°lva egy akci√≥j√°t, b√≥nusz akci√≥j√°t, reakci√≥j√°t vagy sebess√©g√©t. A h√°tba t√°mad√°st egy reakci√≥ elhaszn√°l√°s√°val tudod alkalmazni, ez alatt egy fegyveres vagy puszta kezes k√∂zelharci t√°mad√°st tudsz haszn√°lni a l√©ny ellen. A t√°mad√°s az el≈ëtt t√∂rt√©nik, hogy a l√©ny kil√©pne a kar t√°vols√°godb√≥l</p>
            </div>
            <div *ngFor="let trait of characterData?.traits">
              <div *ngIf="trait.action && trait.action_type=='r'">
                <h4>{{ trait.name }}</h4>
                <span>{{trait.dmg}}</span>
                <p>{{ trait.action_des }}</p>
                
                <!-- Charge boxok -->
                <div class="charge-boxes">
                  <div
                    *ngFor="let c of getChargeArray(trait); let i = index"
                    class="charge-slot"
                    [class.filled]="i < (trait.charge - trait.temp_charge)"
                    (click)="toggleCharge(trait, i)"
                  ></div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- INVENTORY -->
        <div *ngSwitchCase="'Felszerel√©s'" class="tab-content">
          <div id="inventory_title">
            <h2>Felszerel√©s</h2>

            <div class="popup-container">
              <button id="openInventoryBtn" (click)="toggleMenu()">Felszerel√©s hozz√°ad√°sa</button>

              <!-- Felugr√≥ ablak -->
              <div class="popup-overlay" *ngIf="itemAdd">
                <div class="popup-card">
                  <button class="close-btn" (click)="hideMenu()">‚úñ</button>
                  <h3>√öj t√°rgy hozz√°ad√°sa</h3>

                  <!-- Keres≈ë -->
                  <input type="text" placeholder="Keres√©s..." [(ngModel)]="searchTerm" class="search-input">

                  <div class="item-section" *ngIf="filteredItems.fegyver.length" >
                    <h4>‚öîÔ∏è Fegyverek</h4>
                    <div *ngFor="let item of filteredItems.fegyver | itemSearch: searchTerm" (mouseenter)="startTooltipTimer($event, item)" (mouseleave)="hideTooltip()" (mousemove)="moveTooltip($event)">
                      <span>{{ item.name }}</span>
                      <button class="add-item-btn" (click)="addItem(item)">Hozz√°ad√°s</button>
                    </div>
                  </div>

                  <div class="item-section" *ngIf="filteredItems.pancel.length">
                    <h4>üõ°Ô∏è P√°nc√©lok</h4>
                    <div *ngFor="let item of filteredItems.pancel | itemSearch: searchTerm" (mouseenter)="startTooltipTimer($event, item)" (mouseleave)="hideTooltip()" (mousemove)="moveTooltip($event)">
                      <span>{{ item.name }}</span>
                      <button class="add-item-btn" (click)="addItem(item)">Hozz√°ad√°s</button>
                    </div>
                  </div>

                  <div class="item-section" *ngIf="filteredItems.tarolo.length">
                    <h4>üéí T√°rol√≥k</h4>
                    <div *ngFor="let item of filteredItems.tarolo | itemSearch: searchTerm" (mouseenter)="startTooltipTimer($event, item)" (mouseleave)="hideTooltip()" (mousemove)="moveTooltip($event)">
                      <span>{{ item.name }}</span>
                      <button class="add-item-btn" (click)="addItem(item)">Hozz√°ad√°s</button>
                    </div>
                  </div>

                  <div class="item-section" *ngIf="filteredItems.egyeb.length">
                    <h4>üì¶ Egy√©b t√°rgyak</h4>
                    <div *ngFor="let item of filteredItems.egyeb | itemSearch: searchTerm" (mouseenter)="startTooltipTimer($event, item)" (mouseleave)="hideTooltip()" (mousemove)="moveTooltip($event)">
                      <span>{{ item.name }}</span>
                      <input type="number" class="quantity-input" min="1" [(ngModel)]="item.selectedQuantity">
                      <button class="add-item-btn" (click)="addItem(item)">Hozz√°ad√°s</button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div id="inventory_top">
            <div id="maxinv">Teherb√≠r√°s: {{weight +' / '+strengthTotal() * 3  }} kg</div>
            <div class="currency-container">
              <div class="currency-item gold">
                <label>Arany:</label>
                <input type="number" [(ngModel)]="character.gold" (change)="updateCurrency('gold')" min="0">
              </div>

              <div class="currency-item silver">
                <label>Ez√ºst:</label>
                <input type="number" [(ngModel)]="character.silver" (change)="updateCurrency('silver')" min="0">
              </div>

              <div class="currency-item copper">
                <label>R√©z:</label>
                <input type="number" [(ngModel)]="character.copper" (change)="updateCurrency('copper')" min="0">
              </div>
            </div>
          </div>

          <!-- MAIN INVENTORY -->
          <div class="equipment" *ngIf="characterData?.equipment?.length; else noEquipment">
          <table class="equipment-table">
            <thead>
              <tr>
                <th>Felszerel</th>
                <th>N√©v</th>
                <th>S√∫ly/darab</th>
                <th>Mennyis√©g</th>
                <th>√ñssz s√∫ly</th>
                <th>√ârt√©k</th>
                <th>T√°rol√≥</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let item of mainInventory" (mouseenter)="startTooltipTimer($event, item)" (mouseleave)="hideTooltip()" (mousemove)="moveTooltip($event)">
                <td>
                  <ng-container *ngIf="item.type?.includes('fegyver') || item.type?.includes('p√°nc√©l') || item.type?.includes('t√°rol√≥'); else noCheckbox">
                    <input
                      type="checkbox"
                      [checked]="item.felszerelt"
                      #cb
                      (change)="toggleEquip(item, cb.checked)"
                    />
                  </ng-container>
                  <ng-template #noCheckbox>-</ng-template>
                </td>
                <td>{{ item.name }}</td>
                <td>{{ item.weight ? item.weight + ' kg' : '-' }}</td>
                <td>
                  <input 
                    type="number" 
                    min="-1" 
                    [value]="item.db" 
                    (change)="updateItemQuantity(item, $event)" 
                    class="quantity-input"
                  />
                </td>
                <td>{{ item.weight ? (item.weight * (item.db)) + ' kg' : '-' }}</td>
                <td>{{ item.cost ? item.cost + ' gp' : '-' }}</td>
                <td>

                  <div *ngIf="item.type !== 't√°rol√≥'">
                    <select #sel (change)="moveItemToContainer(item, sel.value)" class="container-select">
                      <option value="">V√°lassz t√°rol√≥t</option>
                      <option *ngFor="let c of equippedContainers" [value]="c.id">
                        {{ c.name }} ({{ c.capacity }} kg)
                      </option>
                    </select>
                  </div>
                </td>
              </tr>
            </tbody>
          </table>

          <!-- T√°rol√≥k megjelen√≠t√©se -->
          <div *ngFor="let container of equippedContainers" class="container-block">
            <h4>{{ container.name }}</h4> 
            <div id="capacity">
              Teherb√≠r√°s: {{container.inv_weight/container.light +' / '+ container.capacity  }} kg
            </div>

            <table class="equipment-table">
              <thead>
                <tr>
                  <th>N√©v</th>
                  <th>S√∫ly</th>
                  <th>Mennyis√©g</th>
                  <th>√ñsszs√∫ly</th>
                  <th>M≈±velet</th>
                </tr>
              </thead>
              <tbody>
                <!-- üîπ Csak azokat az itemeket jelen√≠tj√ºk meg, amiknek a t√°rolt mez≈ëje megegyezik a t√°rol√≥ id-j√©vel -->
                <tr *ngFor="let citem of getContainerContents(container.id)" (mouseenter)="startTooltipTimer($event, citem)" (mouseleave)="hideTooltip()" (mousemove)="moveTooltip($event)">
                  <td>{{ citem.name }}</td>
                  <td>{{ citem.weight }} kg</td>
                  <td><input 
                    type="number" 
                    min="-1" 
                    [value]="citem.db" 
                    (change)="updateItemQuantity(citem, $event)" 
                    class="quantity-input"
                  /></td>
                  <td>{{ (citem.weight || 0) * (citem.db || 1) }} kg</td>
                  <td>
                    <button class="small-btn" (click)="removeFromContainer(citem)">
                      Kivesz
                    </button>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
          <!-- Tooltip -->
            <div
              class="item-tooltip"
              *ngIf="tooltipVisible"
              [ngStyle]="{ top: tooltipY + 'px', left: tooltipX + 'px' }"
            >
              <h4>{{ tooltipItem?.name }}</h4>
              <p>{{ tooltipItem?.description }}</p>
            </div>
          </div>
          <ng-template #noEquipment>
            <p>Nincs felszerel√©s.</p>
          </ng-template>
        </div>



        <!-- BACKGROUND -->
        <div *ngSwitchCase="'El≈ë√©let'" class="tab-content">
          <h2>El≈ë√©let</h2>
          <h3>Megjelen√©s:</h3>
          <table class="kinezet">
            <tr>
              <td>
                <strong>N√©v:</strong>
                <p>{{ character.appearance?.name?.trim() || 'N√©vtelen' }}</p>
              </td>
              <td>
                <strong>Kor:</strong>
                <p>{{ character.appearance?.age?.trim() || 'Nincs megadva' }}</p>
              </td>
              <td>
                <strong>Nem:</strong>
                <p>{{ character.appearance?.gender?.trim() || 'Nincs megadva' }}</p>
              </td>
              <td>
                <strong>Magass√°g:</strong>
                <p>{{ character.appearance?.height?.trim() || 'Nincs megadva' }}</p>
              </td>
            </tr>
            <tr>
              <td>
                <strong>S√∫ly:</strong>
                <p>{{ character.appearance?.weight?.trim() || 'Nincs megadva' }}</p>
              </td>
              <td>
                <strong>Szemsz√≠n:</strong>
                <p>{{ character.appearance?.eyeColor?.trim() || 'Nincs megadva' }}</p>
              </td>
              <td>
                <strong>Hajsz√≠n:</strong>
                <p>{{ character.appearance?.hairColor?.trim() || 'Nincs megadva' }}</p>
              </td>
              <td>
                <strong>B≈ërsz√≠n:</strong>
                <p>{{ character.appearance?.skinTone?.trim() || 'Nincs megadva' }}</p>
              </td>
            </tr>
          </table>
          <h3>El≈ë√©let:</h3>
          <strong>{{backgroundName}}</strong>
          <p id="backgroundDescription">{{backgroundDescription}}</p>
        </div>

        <!-- TRAITS -->
        <div *ngSwitchCase="'Jellemz≈ëk'" class="tab-content">
          <h2>Jellemz≈ëk</h2>

          <h3>{{ raceName }}:</h3>
          <ng-container *ngIf="raceTraits.length > 0; else noRaceTraits">
            <div *ngFor="let trait of raceTraits" class="trait-item">
              <strong>{{trait.title}}</strong>
              <p>{{ trait.description }}</p>
            </div>
          </ng-container>
          <ng-template #noRaceTraits>
            <p>Nincsenek fajhoz tartoz√≥ jellemz≈ëk.</p>
          </ng-template>

          <h3>{{ className }}:</h3>
          <ng-container *ngIf="classTraits.length > 0; else noClassTraits">
            <ng-container *ngFor="let trait of classTraits">
              <div class="trait-item" *ngIf="!trait.lvl || trait.lvl <= lvl">
                <strong>{{ trait.title +" ("+trait.lvl +".szint)"}}</strong>
                <p>{{ trait.description }}</p>
              </div>
            </ng-container>
          </ng-container>

          <ng-template #noClassTraits><p>Nincsenek kaszthoz tartoz√≥ jellemz≈ëk.</p></ng-template>

          <h3>{{ backgroundName }}:</h3>
          <ng-container *ngIf="backgroundTraits.length > 0; else noBackgroundTraits">
            <div *ngFor="let trait of backgroundTraits" class="trait-item">
              <strong>{{trait.title}}</strong>
              <p>{{ trait.description }}</p>
            </div>
          </ng-container>
          <ng-template #noBackgroundTraits><p>Nincsenek h√°tt√©rhez tartoz√≥ jellemz≈ëk.</p></ng-template>
        </div>

        <!-- SPELLS -->
        <div *ngSwitchCase="'Var√°zslatok'" class="tab-content">
          <div class="spell-header">
            <h2>Var√°zslatok</h2>
            <button class="spell-btn" (click)="openSpellPopup()">M√°gia bek√©sz√≠t√©se</button>
          </div>
          <div class="spell-stats-container">
            <table class="spell-table">
              <tr>
                <th>M√≥dos√≠t√≥</th>
                <th>Spell Attack</th>
                <th>Save DC</th>               
              </tr>
              <tr>
                <td>{{ spellModifier()>0?"+"+spellModifier():spellModifier() }}</td>
                <td>{{ (spellModifier()+proficiency)>0?"+"+ (spellModifier()+proficiency):(spellModifier()+proficiency) }}</td>
                <td>{{ 8+spellModifier()+proficiency }}</td>
              </tr>
            </table>
            <!-- SPELL SELECTION POPUP -->
            <div class="popup-backdrop" *ngIf="spellPopupVisible">
              <div class="popup-window">

                <button class="close-btn" (click)="closeSpellPopup()">‚úñ</button>

                <div class="popup-header">
                  <h2>Var√°zslat kiv√°laszt√°sa</h2>
                  <br>
                  {{"Bek√©sz√≠tett Var√°zsfort√©lyok: "+(character?.cantrips?.length || 0) +"/"+ varazstoltesMax}}
                  <br>
                  {{"Bek√©sz√≠tett var√°zslatok: "+ (character?.prepared_spells?.length || 0) + "/" + (spellModifier() + lvl) }}
                </div>

                <input 
                  type="text" 
                  placeholder="Keres√©s spellre..."
                  [(ngModel)]="spellSearch"
                  class="search-input"
                />

                <!-- Szintek -->
                <div class="spell-section" *ngFor="let level of [0,1,2,3,4,5,6,7,8,9]">
                  <!-- Csak ha van olyan spell ezen a szinten -->
                  <div *ngIf="(allSpells | spellFilter: spellSearch : className) | hasSpellLevel: level">
                    <ng-container *ngIf="getVarazstoltesTrait().charge[level] !=undefined">
                      <h3>{{ level === 0 ? "Var√°zsfort√©ly" : level + ". szint" }}</h3>
                      <table class="spell-table">
                        <ng-container *ngFor="let spell of (allSpells | spellFilter: spellSearch : className)">
                          <tr *ngIf="spell.lvl === level">
                            <td>{{ spell.name }}</td>
                            <td class="action-buttons">
                              <button  
                                class="prepare-btn"
                                [class.remove]="isSpellPrepared(spell)"
                                (click)="prepareSpell(spell)"
                                [disabled]="isSpellPrepared(spell) ? false : hasReachedLimit(level)"
                              >
                                {{ isSpellPrepared(spell) ? 'T√∂r√∂l' : 'Bek√©sz√≠t' }}
                              </button>
                            </td>
                            <td>
                              <button (click)="toggleSpellDetails(spell, level)" class="details-btn">
                                {{ openedSpellId[level] === spell.name ? 'Bez√°r' : 'B≈ëvebben' }}
                              </button>
                            </td>
                          </tr>

                          <!-- r√©szletek -->
                          <tr *ngIf="openedSpellId[level] === spell.name">
                            <td colspan="3" class="spell-details">
                              <div class="spell-info-box">
                                <table class="spell-details-table">
                                  <tr><td><strong>Iskola:</strong></td><td>{{ spell.school }}</td></tr>
                                  <tr><td><strong>Id≈ë:</strong></td><td>{{ spell.casting_time }}</td></tr>
                                  <tr><td><strong>Hat√≥t√°v:</strong></td><td>{{ spell.range }}</td></tr>
                                  <tr><td><strong>Komponensek:</strong></td><td>{{ spell.component }}</td></tr>
                                  <tr><td><strong>Id≈ëtartam:</strong></td><td>{{ spell.time }}</td></tr>
                                </table>
                                <br>
                                <p>{{ spell.description }}</p>
                              </div>
                            </td>
                          </tr>
                        </ng-container>
                      </table>
                    </ng-container>
                  </div>
                </div>
              </div>
            </div>
            <div class="spell-lists">

              <!-- üîπ Cantripek -->
              <h3 class="left">Var√°zsfort√©lyok</h3>
              <table class="spell-table2">
                <thead>
                  <tr>
                    <th>N√©v</th>
                    <th>Sebz√©s</th>
                    <th>Kit√©r√©s/Tal√°lat</th>
                    <th>Id≈ë</th>
                    <th>Hat√≥t√°v</th>
                    <th>Komponensek</th>
                    <th>Id≈ëtartam</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let spell of character?.cantrips || []">
                    <td>{{ spell.name }}</td>
                    <td>
                      <ng-container *ngIf="spell.dmg && spell.dmg !== ''; else noDmg">
                        <button class="dmg-btn" (click)="rollDamage('',spell.dmg)">{{ spell.dmg }}</button>
                      </ng-container>
                      <ng-template #noDmg>-</ng-template>
                    </td>
                    <td>
                      <ng-container *ngIf="spell.dc === 'tal√°lat'; else dcValue">
                        <button class="dc-btn" (click)="roll((spellModifier()+proficiency))">{{(spellModifier()+proficiency)>0?"+"+ (spellModifier()+proficiency):(spellModifier()+proficiency)}}</button>
                      </ng-container>
                      <ng-template #dcValue>
                        {{ spell.dc === '' || spell.dc == null ? '-' : spell.dc }}
                      </ng-template>
                    </td>
                    <td>{{ spell.casting_time }}</td>
                    <td>{{ spell.range }}</td>
                    <td>{{ spell.component }}</td>
                    <td>{{ spell.time }}</td>
                  </tr>
                  <tr *ngIf="!character?.cantrips?.length">
                    <td colspan="4" class="no-spell">Nincs var√°zsfort√°ly bek√©sz√≠tve.</td>
                  </tr>
                </tbody>
              </table>

              <br>

              <!-- üîπ PrepareSpell-ek szintenk√©nt -->
              <div class="prepared-spells">
                <div *ngFor="let level of [1,2,3,4,5,6,7,8,9]">
                  <ng-container *ngIf="getPreparedSpellsByLevel(level).length > 0 && getVarazstoltesTrait().charge?.[level] !==undefined">
                    <ng-container *ngIf="getVarazstoltesTrait() as vt">
                      <div class="spell-level-header">
                        <h3 class="left">{{ level }}. szint≈± var√°zslatok</h3>
                        <!-- csak akkor jelenjen meg, ha van charge √©s temp_charge -->
                        <div
                          class="charge-boxes"
                          *ngIf="vt.charge?.[level] !== undefined"
                        >
                          <div
                            *ngFor="let c of getChargeArraySpell(vt.charge[level]); let i = index"
                            class="charge-slot"
                            [class.filled]="i < (vt.charge[level] - vt.temp_charge[level])"
                            (click)="toggleSpellCharge(vt, level, i)"
                          ></div>
                        </div>
                      </div>
                    </ng-container>

                    <table class="spell-table2">
                      <thead>
                        <tr>
                          <th>N√©v</th>
                          <th>Sebz√©s</th>
                          <th>Kit√©r√©s/Tal√°lat</th>
                          <th>Id≈ë</th>
                          <th>Hat√≥t√°v</th>
                          <th>Komponensek</th>
                          <th>Id≈ëtartam</th>
                        </tr>
                      </thead>
                      <tbody>
                        <tr *ngFor="let spell of getPreparedSpellsByLevel(level)">
                          <td>{{ spell.name }}</td>
                          <td>
                            <ng-container *ngIf="spell.dmg; else noDmg">
                              <button class="dmg-btn" (click)="rollDamage('', spell.dmg)">
                                {{ spell.dmg }}
                              </button>
                            </ng-container>
                            <ng-template #noDmg>-</ng-template>
                          </td>
                          <td>
                            <ng-container *ngIf="spell.dc === 'tal√°lat'; else dcValue">
                              <button class="dc-btn" (click)="roll(spellModifier() + proficiency)">
                                {{ (spellModifier() + proficiency) > 0 ? '+' + (spellModifier() + proficiency) : (spellModifier() + proficiency) }}
                              </button>
                            </ng-container>
                            <ng-template #dcValue>
                              {{ spell.dc || '-' }}
                            </ng-template>
                          </td>
                          <td>{{ spell.casting_time }}</td>
                          <td>{{ spell.range }}</td>
                          <td>{{ spell.component }}</td>
                          <td>{{ spell.time }}</td>
                        </tr>
                      </tbody>
                    </table>
                  </ng-container>
                </div>
              </div>
            </div>
          </div>
        </div>

      </ng-container>
    </div>
  </div>
</div>
</div>
</div>